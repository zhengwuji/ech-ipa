name: Build Swift iOS IPA

on:
  push:
    branches:
      - main
    paths:
      - 'swift-ios/**'
      - '.github/workflows/build-swift-ios.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: Build Swift iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false
      
      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init
          echo "✅ gomobile 安装完成"
      
      - name: Build ECHClient Framework with gomobile
        run: |
          cd swift-ios/echclient
          
          # 下载依赖
          go mod tidy
          go mod download
          
          # 确保 golang.org/x/mobile 所有子包都在模块缓存中
          go get golang.org/x/mobile@latest
          go get golang.org/x/mobile/bind@latest
          go get golang.org/x/mobile/bind/objc@latest
          go get golang.org/x/mobile/bind/seq@latest
          
          # 使用 gomobile 构建 iOS framework
          echo "正在构建 ECHClient.xcframework..."
          gomobile bind -target=ios -o ../ECHClient.xcframework .
          
          echo "✅ ECHClient.xcframework 构建完成"
          ls -la ../ECHClient.xcframework/
      
      - name: Setup project structure
        run: |
          cd swift-ios
          
          echo "准备项目文件..."
          chmod +x create_xcode_project.sh
          ./create_xcode_project.sh
          
          # 生成各种尺寸的图标 (使用 sips 命令)
          if [ -f Assets.xcassets/AppIcon.appiconset/Icon-1024.png ]; then
            echo "生成应用图标..."
            cd Assets.xcassets/AppIcon.appiconset
            sips -z 120 120 Icon-1024.png --out Icon-60@2x.png
            sips -z 180 180 Icon-1024.png --out Icon-60@3x.png
            sips -z 76 76 Icon-1024.png --out Icon-76.png
            sips -z 152 152 Icon-1024.png --out Icon-76@2x.png
            sips -z 167 167 Icon-1024.png --out Icon-83.5@2x.png
            cd ../..
            echo "✅ 应用图标生成完成"
          fi
          
          echo "✅ 项目结构创建完成"
          ls -la
      
      - name: Create temporary signing certificate
        run: |
          # 创建临时 keychain
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # 创建自签名证书
          cat > cert.conf << EOF
          [ req ]
          default_bits       = 2048
          distinguished_name = req_distinguished_name
          x509_extensions    = v3_ca
          prompt             = no
          
          [ req_distinguished_name ]
          CN = TrollStore Temp Cert
          
          [ v3_ca ]
          basicConstraints = critical,CA:TRUE
          keyUsage = critical,keyCertSign,cRLSign,digitalSignature
          EOF
          
          # 生成证书
          openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 1 -nodes -config cert.conf
          openssl pkcs12 -export -out cert.p12 -inkey key.pem -in cert.pem -passout pass:temp
          
          # 导入证书到 keychain
          security import cert.p12 -k build.keychain -P temp -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k actions build.keychain
          
          # 查找证书身份
          CERT_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "TrollStore Temp Cert" | awk '{print $2}')
          echo "CERT_IDENTITY=$CERT_IDENTITY" >> $GITHUB_ENV
          echo "✅ 临时签名证书已创建: $CERT_IDENTITY"
      
      - name: Build with xcodebuild
        run: |
          cd swift-ios
          
          echo "项目结构:"
          ls -la
          echo "ECHWorkers 目录:"
          ls -la ECHWorkers/ || true
          
          echo "使用 xcodebuild 构建..."
          echo "使用证书: $CERT_IDENTITY"
          
          # 使用临时签名证书构建
          xcodebuild \
            -project ECHWorkers.xcodeproj \
            -scheme ECHWorkers \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="$CERT_IDENTITY" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            ONLY_ACTIVE_ARCH=NO \
            ARCHS=arm64 \
            IPHONEOS_DEPLOYMENT_TARGET=14.0 \
            2>&1 | tee build.log || (cat build.log && exit 1)
          
          echo "✅ 构建完成"
          
          # 查找生成的.app
          APP_PATH=$(find ./build -name "*.app" -type d | head -n 1)
          echo "找到应用: $APP_PATH"
          
          # 验证可执行文件是否有效
          if [ -n "$APP_PATH" ]; then
            if [ ! -f "$APP_PATH/ECHWorkers" ]; then
              echo "❌ 错误: 可执行文件不存在"
              exit 1
            fi
            
            # 检查文件大小（不能为空）
            FILE_SIZE=$(stat -f%z "$APP_PATH/ECHWorkers" 2>/dev/null || stat -c%s "$APP_PATH/ECHWorkers" 2>/dev/null || echo "0")
            if [ "$FILE_SIZE" -eq 0 ]; then
              echo "❌ 错误: 可执行文件为空"
              exit 1
            fi
            echo "可执行文件大小: $FILE_SIZE 字节"
            
            # 检查文件类型
            echo "文件类型:"
            file "$APP_PATH/ECHWorkers"
            
            # 检查架构
            echo "架构信息:"
            lipo -info "$APP_PATH/ECHWorkers" || (echo "❌ lipo 检查失败" && exit 1)
            
            # 检查当前签名
            echo "当前签名:"
            codesign -dv "$APP_PATH/ECHWorkers" 2>&1 || true
            
            # 移除原有签名（TrollStore 兼容）
            echo "移除签名..."
            codesign --remove-signature "$APP_PATH/ECHWorkers" 2>/dev/null || true
            codesign --remove-signature "$APP_PATH" 2>/dev/null || true
            rm -rf "$APP_PATH/_CodeSignature" 2>/dev/null || true
            
            # 再次验证文件类型（确保移除签名后仍然有效）
            echo "移除签名后的文件类型:"
            file "$APP_PATH/ECHWorkers"
            
            # 验证 Mach-O 格式
            echo "验证 Mach-O 格式..."
            if ! file "$APP_PATH/ECHWorkers" | grep -q "Mach-O"; then
              echo "❌ 错误: 可执行文件不是有效的 Mach-O 格式"
              exit 1
            fi
            
            # 确保可执行权限
            chmod +x "$APP_PATH/ECHWorkers"
            
            # 使用 otool 验证可执行文件
            echo "使用 otool 验证:"
            otool -h "$APP_PATH/ECHWorkers" || (echo "❌ otool 验证失败" && exit 1)
            
            echo "✅ 可执行文件验证通过"
          fi
          
          # 复制 ECHClient.xcframework 到 .app/Frameworks
          if [ -d ECHClient.xcframework ] && [ -n "$APP_PATH" ]; then
            echo "复制 ECHClient.xcframework..."
            mkdir -p "$APP_PATH/Frameworks"
            # 找到 ios-arm64 的 framework
            if [ -d "ECHClient.xcframework/ios-arm64/ECHClient.framework" ]; then
              cp -r "ECHClient.xcframework/ios-arm64/ECHClient.framework" "$APP_PATH/Frameworks/"
              
              # 移除 framework 的签名
              codesign --remove-signature "$APP_PATH/Frameworks/ECHClient.framework/ECHClient" 2>/dev/null || true
              codesign --remove-signature "$APP_PATH/Frameworks/ECHClient.framework" 2>/dev/null || true
              rm -rf "$APP_PATH/Frameworks/ECHClient.framework/_CodeSignature" 2>/dev/null || true
              
              echo "✅ ECHClient.framework 已复制"
            fi
          fi
          
          # 复制.app到当前目录
          if [ -n "$APP_PATH" ]; then
            cp -r "$APP_PATH" ./ECHWorkers.app
            
            # 验证复制后的可执行文件
            if [ -f "./ECHWorkers.app/ECHWorkers" ]; then
              echo "验证复制后的可执行文件..."
              file "./ECHWorkers.app/ECHWorkers"
              otool -h "./ECHWorkers.app/ECHWorkers" || (echo "❌ 复制后验证失败" && exit 1)
              echo "✅ 复制后验证通过"
            fi
          fi
          
          # 显示最终 app 大小
          echo "App 内容:"
          ls -la ./ECHWorkers.app/
          echo "App 总大小:"
          du -sh ./ECHWorkers.app/
      
      - name: Package IPA
        run: |
          cd swift-ios
          
          # 最终验证可执行文件
          if [ -f "./ECHWorkers.app/ECHWorkers" ]; then
            echo "最终验证可执行文件..."
            file "./ECHWorkers.app/ECHWorkers"
            otool -h "./ECHWorkers.app/ECHWorkers" || (echo "❌ 最终验证失败" && exit 1)
            echo "✅ 可执行文件验证通过"
          else
            echo "❌ 错误: 可执行文件不存在"
            exit 1
          fi
          
          # 创建 Payload 目录
          mkdir -p Payload
          cp -r ECHWorkers.app Payload/
          
          # 再次验证 Payload 中的可执行文件
          if [ -f "Payload/ECHWorkers.app/ECHWorkers" ]; then
            echo "验证 Payload 中的可执行文件..."
            file "Payload/ECHWorkers.app/ECHWorkers"
            otool -h "Payload/ECHWorkers.app/ECHWorkers" || (echo "❌ Payload 验证失败" && exit 1)
          fi
          
          # 打包为 IPA
          zip -r ../ECHWorkers-Swift-unsigned.ipa Payload
          
          cd ..
          echo "✅ IPA打包完成"
          ls -lh ECHWorkers-Swift-unsigned.ipa
      
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges | head -n 20)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Swift原生iOS版本首次发布"
          fi
          
          echo "$CHANGELOG" > CHANGELOG.txt
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ECHWorkers-Swift-iOS
          path: "ECHWorkers-Swift-unsigned.ipa"
      
      - name: Generate release tag
        id: tag
        run: |
          TAG="ios-swift-v1.2.0-$(date +'%Y%m%d-%H%M%S')"
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: "iOS Swift版本 ${{ steps.tag.outputs.release_tag }}"
          body: |
            # ECH Workers - Swift原生iOS版本
            
            **✅ 完整ECH功能 + 原生Swift界面**
            
            ## 特性
            
            - ✅ 原生SwiftUI界面
            - ✅ 完整ECH加密支持 (Go 1.23)
            - ✅ WebSocket隧道
            - ✅ SOCKS5代理
            - ✅ TrollStore完美支持
            
            ## 安装方法
            
            ### TrollStore安装（推荐）
            1. 下载 `ECHWorkers-Swift-unsigned.ipa`
            2. 在TrollStore中安装
            3. 打开应用即可使用
            
            ### 其他签名工具
            - AltStore
            - Sideloadly
            - 爱思助手
            
            ## 使用说明
            
            1. 打开应用
            2. 填写服务器地址
            3. 点击"启动代理"
            4. 在系统设置中配置SOCKS5代理：127.0.0.1:30000
            
            ## 更新日志
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            
            **版本**: 1.2.0-Swift
            **最低iOS版本**: 14.0
            **架构**: arm64
          files: |
            ECHWorkers-Swift-unsigned.ipa
            CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
