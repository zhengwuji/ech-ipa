name: Build Swift iOS IPA

on:
  push:
    branches:
      - main
    paths:
      - 'swift-ios/**'
      - '.github/workflows/build-swift-ios.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: Build Swift iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get commit hash
        id: commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "âœ… Commit hash: $COMMIT_HASH"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Setup project structure
        run: |
          cd swift-ios
          
          echo "å‡†å¤‡çº¯ Swift é¡¹ç›®ï¼ˆæ—  Go/gomobile ä¾èµ–ï¼‰..."
          chmod +x create_xcode_project.sh
          ./create_xcode_project.sh
          
          # ç”Ÿæˆå„ç§å°ºå¯¸çš„å›¾æ ‡
          if [ -f Assets.xcassets/AppIcon.appiconset/Icon-1024.png ]; then
            echo "ç”Ÿæˆåº”ç”¨å›¾æ ‡..."
            cd Assets.xcassets/AppIcon.appiconset
            sips -z 120 120 Icon-1024.png --out Icon-60@2x.png
            sips -z 180 180 Icon-1024.png --out Icon-60@3x.png
            sips -z 76 76 Icon-1024.png --out Icon-76.png
            sips -z 152 152 Icon-1024.png --out Icon-76@2x.png
            sips -z 167 167 Icon-1024.png --out Icon-83.5@2x.png
            cd ../..
            echo "âœ… åº”ç”¨å›¾æ ‡ç”Ÿæˆå®Œæˆ"
          fi
          
          echo "âœ… çº¯ Swift é¡¹ç›®ç»“æ„åˆ›å»ºå®Œæˆ"
          echo "é¡¹ç›®å†…å®¹:"
          ls -la
          echo "Swift æºæ–‡ä»¶:"
          ls -la *.swift
      
      - name: Build with xcodebuild
        run: |
          cd swift-ios
          
          echo "é¡¹ç›®ç»“æ„:"
          ls -la
          echo "ECHWorkers ç›®å½•:"
          ls -la ECHWorkers/ || true
          
          echo "ä½¿ç”¨ xcodebuild æ„å»ºçº¯ Swift åº”ç”¨ï¼ˆæ—  Framework ä¾èµ–ï¼‰..."
          
          # æ„å»ºçº¯ Swift åº”ç”¨ï¼Œæ— ä»»ä½• Framework
          xcodebuild \
            -project ECHWorkers.xcodeproj \
            -scheme ECHWorkers \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            ONLY_ACTIVE_ARCH=NO \
            ARCHS=arm64 \
            IPHONEOS_DEPLOYMENT_TARGET=14.0 \
            2>&1 | tee build.log || (cat build.log && exit 1)
          
          echo "âœ… æ„å»ºå®Œæˆ"
          
          # æŸ¥æ‰¾ç”Ÿæˆçš„.app
          APP_PATH=$(find ./build -name "*.app" -type d | head -n 1)
          echo "æ‰¾åˆ°åº”ç”¨: $APP_PATH"
          
          # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
          if [ -n "$APP_PATH" ]; then
            if [ ! -f "$APP_PATH/ECHWorkers" ]; then
              echo "âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            FILE_SIZE=$(stat -f%z "$APP_PATH/ECHWorkers" 2>/dev/null || stat -c%s "$APP_PATH/ECHWorkers" 2>/dev/null || echo "0")
            if [ "$FILE_SIZE" -eq 0 ]; then
              echo "âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶ä¸ºç©º"
              exit 1
            fi
            echo "å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            
            # æ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œæ¶æ„
            echo "æ–‡ä»¶ç±»å‹:"
            file "$APP_PATH/ECHWorkers"
            
            echo "æ¶æ„ä¿¡æ¯:"
            lipo -info "$APP_PATH/ECHWorkers" || (echo "âŒ lipo æ£€æŸ¥å¤±è´¥" && exit 1)
            
            # éªŒè¯æ¶æ„æ˜¯ arm64
            APP_ARCH=$(lipo -info "$APP_PATH/ECHWorkers" 2>&1)
            if ! echo "$APP_ARCH" | grep -q "arm64"; then
              echo "âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶æ¶æ„ä¸æ˜¯ arm64: $APP_ARCH"
              exit 1
            fi
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶æ¶æ„éªŒè¯é€šè¿‡: $APP_ARCH"
            
            # æ¸…ç†æ—§ç­¾åå¹¶é‡æ–°ç­¾å (Clean and Re-sign with Entitlements)
            echo "æ­£åœ¨å¤„ç†ç­¾å..."
            rm -rf "$APP_PATH/_CodeSignature" 2>/dev/null || true
            rm -rf "$APP_PATH/embedded.mobileprovision" 2>/dev/null || true
            
            # ä½¿ç”¨ Entitlements è¿›è¡Œä¼ªç­¾å
            echo "æ­£åœ¨æ³¨å…¥ Entitlements..."
            if [ -f "ECHWorkers.entitlements" ]; then
                # ä½¿ç”¨ ad-hoc ç­¾åæ³¨å…¥ entitlements
                codesign -s - --entitlements "ECHWorkers.entitlements" --force "$APP_PATH/ECHWorkers"
                echo "âœ… å·²æ³¨å…¥ Entitlements å¹¶å®Œæˆä¼ªç­¾å"
                
                # éªŒè¯ entitlements
                echo "éªŒè¯ç­¾ååŒ…å«çš„ Entitlements:"
                codesign -d --entitlements :- "$APP_PATH/ECHWorkers"
            else
                echo "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° ECHWorkers.entitlements æ–‡ä»¶ï¼Œè·³è¿‡ Entitlements æ³¨å…¥"
                # è‡³å°‘åšä¸€ä¸ªåŸºç¡€ç­¾å
                codesign -s - --force "$APP_PATH/ECHWorkers"
            fi
            
            # ç¡®ä¿å¯æ‰§è¡Œæƒé™
            chmod +x "$APP_PATH/ECHWorkers"
            
            # ä½¿ç”¨ otool éªŒè¯
            echo "ä½¿ç”¨ otool éªŒè¯:"
            otool -h "$APP_PATH/ECHWorkers" || (echo "âŒ otool éªŒè¯å¤±è´¥" && exit 1)
            
            echo "âœ… çº¯ Swift å¯æ‰§è¡Œæ–‡ä»¶éªŒè¯é€šè¿‡"
          fi
          
          # å¤åˆ¶ .app
          if [ -n "$APP_PATH" ]; then
            cp -R "$APP_PATH" ./ECHWorkers.app
            
            # éªŒè¯å¤åˆ¶åçš„æ–‡ä»¶
            if [ -f "./ECHWorkers.app/ECHWorkers" ]; then
              echo "éªŒè¯å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶..."
              file "./ECHWorkers.app/ECHWorkers"
              otool -h "./ECHWorkers.app/ECHWorkers" || (echo "âŒ å¤åˆ¶åéªŒè¯å¤±è´¥" && exit 1)
              chmod +x "./ECHWorkers.app/ECHWorkers"
              echo "âœ… å¤åˆ¶åéªŒè¯é€šè¿‡"
            fi
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆ app å¤§å°
          echo "App å†…å®¹:"
          ls -la ./ECHWorkers.app/
          echo "App æ€»å¤§å°:"
          du -sh ./ECHWorkers.app/
      
      - name: Package IPA
        run: |
          cd swift-ios
          
          # æœ€ç»ˆéªŒè¯
          if [ -f "./ECHWorkers.app/ECHWorkers" ]; then
            echo "æœ€ç»ˆéªŒè¯å¯æ‰§è¡Œæ–‡ä»¶..."
            file "./ECHWorkers.app/ECHWorkers"
            otool -h "./ECHWorkers.app/ECHWorkers" || (echo "âŒ æœ€ç»ˆéªŒè¯å¤±è´¥" && exit 1)
            
            # éªŒè¯ Info.plist
            if [ ! -f "./ECHWorkers.app/Info.plist" ]; then
              echo "âŒ é”™è¯¯: Info.plist ä¸å­˜åœ¨"
              exit 1
            fi
            
            echo "âœ… çº¯ Swift åº”ç”¨éªŒè¯é€šè¿‡"
          else
            echo "âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # åˆ›å»º Payload ç›®å½•
          mkdir -p Payload
          cp -R ECHWorkers.app Payload/
          
          # ç¡®ä¿æƒé™æ­£ç¡®
          chmod 755 "Payload/ECHWorkers.app"
          find "Payload/ECHWorkers.app" -type d -exec chmod 755 {} \; 2>/dev/null || true
          find "Payload/ECHWorkers.app" -type f -perm +111 -exec chmod 755 {} \; 2>/dev/null || true
          find "Payload/ECHWorkers.app" -type f ! -perm +111 -exec chmod 644 {} \; 2>/dev/null || true
          
          # å½»åº•æ¸…ç†
          echo "æ¸…ç† .app bundle..."
          find "Payload/ECHWorkers.app" -name ".DS_Store" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "._*" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name ".git*" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -type l -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "embedded.mobileprovision" -delete 2>/dev/null || true
          
          # æœ€ç»ˆéªŒè¯æ¶æ„
          echo "æœ€ç»ˆéªŒè¯æ¶æ„..."
          if [ -f "Payload/ECHWorkers.app/ECHWorkers" ]; then
            ARCH_INFO=$(lipo -info "Payload/ECHWorkers.app/ECHWorkers" 2>&1)
            echo "âœ… æ¶æ„: $ARCH_INFO"
            
            if ! echo "$ARCH_INFO" | grep -q "arm64"; then
              echo "âš ï¸ è­¦å‘Š: ä¸æ˜¯ arm64 æ¶æ„"
            fi
          fi
          
          # è·å– commit hash
          COMMIT_HASH="${{ steps.commit.outputs.commit_hash }}"
          IPA_NAME="${COMMIT_HASH}-ECHWorkers-Swift-Pure-unsigned.ipa"
          
          # æ‰“åŒ… IPA
          zip -0 -r "../${IPA_NAME}" Payload
          
          cd ..
          echo "âœ… IPA æ‰“åŒ…å®Œæˆ: ${IPA_NAME}"
          ls -lh "${IPA_NAME}"
          
          # ä¿å­˜ IPA æ–‡ä»¶å
          echo "IPA_NAME=${IPA_NAME}" >> $GITHUB_ENV
      
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges | head -n 20)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Swift çº¯åŸç”Ÿç‰ˆæœ¬é¦–æ¬¡å‘å¸ƒï¼ˆæ—  Go ä¾èµ–ï¼‰"
          fi
          
          echo "$CHANGELOG" > CHANGELOG.txt
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ECHWorkers-Swift-Pure-iOS
          path: "${{ env.IPA_NAME }}"
      
      - name: Generate release tag
        id: tag
        run: |
          TAG="ios-swift-pure-v2.0.0-$(date +'%Y%m%d-%H%M%S')"
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: "iOS çº¯ Swift ç‰ˆæœ¬ ${{ steps.tag.outputs.release_tag }}"
          body: |
            # ECH Workers - çº¯ Swift åŸç”Ÿç‰ˆæœ¬ 2.0
            
            **ğŸ‰ å®Œå…¨é‡å†™ - æ—  Go/gomobile ä¾èµ–**
            
            ## ç‰¹æ€§
            
            - âœ… 100% çº¯ Swift ä»£ç 
            - âœ… ä½¿ç”¨ iOS åŸç”Ÿ Network.framework
            - âœ… ECH åŠ å¯†æ”¯æŒï¼ˆiOS åŸç”Ÿå®ç°ï¼‰
            - âœ… WebSocket éš§é“
            - âœ… SOCKS5 ä»£ç†
            - âœ… æ— ä»»ä½• Framework ä¾èµ–
            - âœ… å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶
            - âœ… å®Œç¾é€‚é…çˆ±æ€åŠ©æ‰‹ç­¾å
            
            ## å®‰è£…æ–¹æ³•
            
            ### çˆ±æ€åŠ©æ‰‹ï¼ˆæ¨èï¼‰
            1. ä¸‹è½½ `${{ env.IPA_NAME }}`
            2. æ‰“å¼€çˆ±æ€åŠ©æ‰‹
            3. å¯¼å…¥ IPA å¹¶ç­¾åå®‰è£…
            4. âœ… åº”è¯¥èƒ½æˆåŠŸç­¾åï¼ˆçº¯ Swiftï¼Œæ— å¤æ‚ä¾èµ–ï¼‰
            
            ### TrollStore
            1. ä¸‹è½½ IPA
            2. åœ¨ TrollStore ä¸­å®‰è£…
            3. æ‰“å¼€åº”ç”¨å³å¯ä½¿ç”¨
            
            ## æŠ€æœ¯è¯´æ˜
            
            - **æ—  Go ä»£ç **: å®Œå…¨ç§»é™¤äº† gomobile å’Œæ‰€æœ‰ Go ä¾èµ–
            - **åŸç”Ÿ ECH**: ä½¿ç”¨ iOS ç³»ç»Ÿçš„ TLS 1.3 å’Œ ECH æ”¯æŒ
            - **çº¯ Swift**: æ‰€æœ‰ç½‘ç»œé€»è¾‘ä½¿ç”¨ Network.framework å®ç°
            - **å•ä¸€äºŒè¿›åˆ¶**: æ—  Frameworkï¼Œæ— åŠ¨æ€åº“ï¼Œåªæœ‰ä¸»æ‰§è¡Œæ–‡ä»¶
            
            ## æ›´æ–°æ—¥å¿—
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            
            **ç‰ˆæœ¬**: 2.0.0-Pure-Swift  
            **æœ€ä½ iOS ç‰ˆæœ¬**: 14.0  
            **æ¶æ„**: arm64  
            **Commit**: ${{ steps.commit.outputs.commit_hash }}
          files: |
            ${{ env.IPA_NAME }}
            CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
