name: Build Swift iOS IPA

on:
  push:
    branches:
      - main
    paths:
      - 'swift-ios/**'
      - '.github/workflows/build-swift-ios.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: Build Swift iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: false
      
      - name: Build ech-workers binary for iOS
        run: |
          echo "编译 ech-workers 为 iOS (darwin/arm64)..."
          
          # 复制 go.mod
          cp ech-wk-package/src/go.mod ./go.mod
          cp ech-wk-package/src/go.sum ./go.sum 2>/dev/null || true
          
          # 整理依赖
          go mod tidy
          go mod download
          
          # 编译为 iOS arm64
          GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 go build -o ech-workers-ios -ldflags="-s -w" ech-workers.go
          
          # 复制到Swift项目
          mkdir -p swift-ios/Resources
          cp ech-workers-ios swift-ios/Resources/ech-workers
          chmod +x swift-ios/Resources/ech-workers
          
          echo "✅ ech-workers编译完成"
          ls -lh swift-ios/Resources/ech-workers
      
      
      - name: Setup project structure
        run: |
          cd swift-ios
          
          echo "准备项目文件..."
          chmod +x create_xcode_project.sh
          ./create_xcode_project.sh
          
          echo "✅ 项目结构创建完成"
          ls -la
      
      - name: Build with xcodebuild
        run: |
          cd swift-ios
          
          echo "使用xcodebuild构建..."
          
          xcodebuild \
            -project ECHWorkers.xcodeproj \
            -scheme ECHWorkers \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            ARCHS=arm64 \
            IPHONEOS_DEPLOYMENT_TARGET=14.0 \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES
          
          echo "✅ 构建完成"
          
          # 查找生成的.app
          APP_PATH=$(find ./build -name "*.app" -type d | head -n 1)
          echo "找到应用: $APP_PATH"
          
          # 确保可执行文件有执行权限
          if [ -n "$APP_PATH" ]; then
            chmod +x "$APP_PATH/ECHWorkers"
            echo "✅ 设置可执行权限"
          fi
          
          # 复制 ech-workers 到 .app 根目录 (不放在 Resources 里，避免 TrollStore 问题)
          if [ -d Resources ] && [ -n "$APP_PATH" ]; then
            echo "复制 ech-workers..."
            cp Resources/ech-workers "$APP_PATH/ech-workers"
            chmod +x "$APP_PATH/ech-workers"
            echo "✅ 设置 ech-workers 可执行权限"
          fi
          
          # 复制.app到当前目录
          if [ -n "$APP_PATH" ]; then
            cp -r "$APP_PATH" ./ECHWorkers.app
          fi
      
      - name: Package IPA
        run: |
          cd swift-ios
          
          # 创建 Payload 目录
          mkdir -p Payload
          cp -r ECHWorkers.app Payload/
          
          # 打包为 IPA
          zip -r ../ECHWorkers-Swift-unsigned.ipa Payload
          
          cd ..
          echo "✅ IPA打包完成"
          ls -lh ECHWorkers-Swift-unsigned.ipa
      
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges | head -n 20)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Swift原生iOS版本首次发布"
          fi
          
          echo "$CHANGELOG" > CHANGELOG.txt
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ECHWorkers-Swift-iOS
          path: "ECHWorkers-Swift-unsigned.ipa"
      
      - name: Generate release tag
        id: tag
        run: |
          TAG="ios-swift-v1.2.0-$(date +'%Y%m%d-%H%M%S')"
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: "iOS Swift版本 ${{ steps.tag.outputs.release_tag }}"
          body: |
            # ECH Workers - Swift原生iOS版本
            
            **✅ 原生Swift开发 - 稳定不闪退**
            
            ## 特性
            
            - ✅ 原生SwiftUI界面
            - ✅ 完全稳定，无闪退问题
            - ✅ TrollStore完美支持
            - ✅ 所有功能完整实现
            
            ## 安装方法
            
            ### TrollStore安装（推荐）
            1. 下载 `ECHWorkers-Swift-unsigned.ipa`
            2. 在TrollStore中安装
            3. 打开应用即可使用
            
            ### 其他签名工具
            - AltStore
            - Sideloadly
            - 爱思助手
            
            ## 使用说明
            
            1. 打开应用
            2. 填写服务器地址
            3. 点击"启动代理"
            4. 在系统设置中配置SOCKS5代理：127.0.0.1:30000
            
            ## 更新日志
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            
            **版本**: 1.2.0-Swift
            **最低iOS版本**: 12.0
            **架构**: arm64
          files: |
            ECHWorkers-Swift-unsigned.ipa
            CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
