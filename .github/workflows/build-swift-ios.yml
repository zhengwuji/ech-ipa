name: Build Swift iOS IPA

on:
  push:
    branches:
      - main
    paths:
      - 'swift-ios/**'
      - '.github/workflows/build-swift-ios.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: Build Swift iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false
      
      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init
          echo "✅ gomobile 安装完成"
      
      - name: Build ECHClient Framework with gomobile
        run: |
          cd swift-ios/echclient
          
          # 下载依赖
          go mod tidy
          go mod download
          
          # 确保 golang.org/x/mobile 所有子包都在模块缓存中
          go get golang.org/x/mobile@latest
          go get golang.org/x/mobile/bind@latest
          go get golang.org/x/mobile/bind/objc@latest
          go get golang.org/x/mobile/bind/seq@latest
          
          # 使用 gomobile 构建 iOS framework
          echo "正在构建 ECHClient.xcframework..."
          gomobile bind -target=ios -o ../ECHClient.xcframework .
          
          echo "✅ ECHClient.xcframework 构建完成"
          ls -la ../ECHClient.xcframework/
      
      - name: Setup project structure
        run: |
          cd swift-ios
          
          echo "准备项目文件..."
          chmod +x create_xcode_project.sh
          ./create_xcode_project.sh
          
          # 生成各种尺寸的图标 (使用 sips 命令)
          if [ -f Assets.xcassets/AppIcon.appiconset/Icon-1024.png ]; then
            echo "生成应用图标..."
            cd Assets.xcassets/AppIcon.appiconset
            sips -z 120 120 Icon-1024.png --out Icon-60@2x.png
            sips -z 180 180 Icon-1024.png --out Icon-60@3x.png
            sips -z 76 76 Icon-1024.png --out Icon-76.png
            sips -z 152 152 Icon-1024.png --out Icon-76@2x.png
            sips -z 167 167 Icon-1024.png --out Icon-83.5@2x.png
            cd ../..
            echo "✅ 应用图标生成完成"
          fi
          
          echo "✅ 项目结构创建完成"
          ls -la
      
      - name: Build with xcodebuild
        run: |
          cd swift-ios
          
          echo "项目结构:"
          ls -la
          echo "ECHWorkers 目录:"
          ls -la ECHWorkers/ || true
          
          echo "使用xcodebuild构建..."
          
          # 允许自动签名构建，之后再处理签名
          xcodebuild \
            -project ECHWorkers.xcodeproj \
            -scheme ECHWorkers \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ./build \
            ONLY_ACTIVE_ARCH=NO \
            ARCHS=arm64 \
            IPHONEOS_DEPLOYMENT_TARGET=14.0 \
            2>&1 | tee build.log || (cat build.log && exit 1)
          
          echo "✅ 构建完成"
          
          # 查找生成的.app
          APP_PATH=$(find ./build -name "*.app" -type d | head -n 1)
          echo "找到应用: $APP_PATH"
          
          # 验证可执行文件是否有效
          if [ -n "$APP_PATH" ]; then
            if [ ! -f "$APP_PATH/ECHWorkers" ]; then
              echo "❌ 错误: 可执行文件不存在"
              exit 1
            fi
            
            # 检查文件类型
            file "$APP_PATH/ECHWorkers"
            
            # 检查架构
            lipo -info "$APP_PATH/ECHWorkers" || echo "警告: lipo 检查失败"
            
            # 移除原有签名并重新签名（TrollStore 兼容）
            echo "处理代码签名..."
            codesign --remove-signature "$APP_PATH/ECHWorkers" 2>/dev/null || true
            codesign --remove-signature "$APP_PATH" 2>/dev/null || true
            
            # 移除 _CodeSignature 目录
            rm -rf "$APP_PATH/_CodeSignature" 2>/dev/null || true
            
            # 确保可执行权限
            chmod +x "$APP_PATH/ECHWorkers"
            echo "✅ 可执行文件验证通过"
          fi
          
          # 复制 ECHClient.xcframework 到 .app/Frameworks
          if [ -d ECHClient.xcframework ] && [ -n "$APP_PATH" ]; then
            echo "复制 ECHClient.xcframework..."
            mkdir -p "$APP_PATH/Frameworks"
            # 找到 ios-arm64 的 framework
            if [ -d "ECHClient.xcframework/ios-arm64/ECHClient.framework" ]; then
              cp -r "ECHClient.xcframework/ios-arm64/ECHClient.framework" "$APP_PATH/Frameworks/"
              
              # 移除 framework 的签名
              codesign --remove-signature "$APP_PATH/Frameworks/ECHClient.framework/ECHClient" 2>/dev/null || true
              codesign --remove-signature "$APP_PATH/Frameworks/ECHClient.framework" 2>/dev/null || true
              rm -rf "$APP_PATH/Frameworks/ECHClient.framework/_CodeSignature" 2>/dev/null || true
              
              echo "✅ ECHClient.framework 已复制"
            fi
          fi
          
          # 复制.app到当前目录
          if [ -n "$APP_PATH" ]; then
            cp -r "$APP_PATH" ./ECHWorkers.app
          fi
          
          # 显示最终 app 大小
          echo "App 内容:"
          ls -la ./ECHWorkers.app/
          echo "App 总大小:"
          du -sh ./ECHWorkers.app/
      
      - name: Package IPA
        run: |
          cd swift-ios
          
          # 创建 Payload 目录
          mkdir -p Payload
          cp -r ECHWorkers.app Payload/
          
          # 打包为 IPA
          zip -r ../ECHWorkers-Swift-unsigned.ipa Payload
          
          cd ..
          echo "✅ IPA打包完成"
          ls -lh ECHWorkers-Swift-unsigned.ipa
      
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges | head -n 20)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Swift原生iOS版本首次发布"
          fi
          
          echo "$CHANGELOG" > CHANGELOG.txt
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ECHWorkers-Swift-iOS
          path: "ECHWorkers-Swift-unsigned.ipa"
      
      - name: Generate release tag
        id: tag
        run: |
          TAG="ios-swift-v1.2.0-$(date +'%Y%m%d-%H%M%S')"
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: "iOS Swift版本 ${{ steps.tag.outputs.release_tag }}"
          body: |
            # ECH Workers - Swift原生iOS版本
            
            **✅ 完整ECH功能 + 原生Swift界面**
            
            ## 特性
            
            - ✅ 原生SwiftUI界面
            - ✅ 完整ECH加密支持 (Go 1.23)
            - ✅ WebSocket隧道
            - ✅ SOCKS5代理
            - ✅ TrollStore完美支持
            
            ## 安装方法
            
            ### TrollStore安装（推荐）
            1. 下载 `ECHWorkers-Swift-unsigned.ipa`
            2. 在TrollStore中安装
            3. 打开应用即可使用
            
            ### 其他签名工具
            - AltStore
            - Sideloadly
            - 爱思助手
            
            ## 使用说明
            
            1. 打开应用
            2. 填写服务器地址
            3. 点击"启动代理"
            4. 在系统设置中配置SOCKS5代理：127.0.0.1:30000
            
            ## 更新日志
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            
            **版本**: 1.2.0-Swift
            **最低iOS版本**: 14.0
            **架构**: arm64
          files: |
            ECHWorkers-Swift-unsigned.ipa
            CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
