name: Build Swift iOS IPA

on:
  push:
    branches:
      - main
    paths:
      - 'swift-ios/**'
      - '.github/workflows/build-swift-ios.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: Build Swift iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get commit hash
        id: commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "âœ… Commit hash: $COMMIT_HASH"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false
      
      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init
          echo "âœ… gomobile å®‰è£…å®Œæˆ"
      
      - name: Build ECHClient Framework with gomobile
        run: |
          cd swift-ios/echclient
          
          # ä¸‹è½½ä¾èµ–
          go mod tidy
          go mod download
          
          # ç¡®ä¿ golang.org/x/mobile æ‰€æœ‰å­åŒ…éƒ½åœ¨æ¨¡å—ç¼“å­˜ä¸­
          go get golang.org/x/mobile@latest
          go get golang.org/x/mobile/bind@latest
          go get golang.org/x/mobile/bind/objc@latest
          go get golang.org/x/mobile/bind/seq@latest
          
          # ä½¿ç”¨ gomobile æ„å»º iOS framework - åªæ„å»º arm64 çœŸæœºæ¶æ„
          echo "æ­£åœ¨æ„å»º ECHClient.xcframework (arm64 only)..."
          gomobile bind -target=ios -iosversion=14.0 -o ../ECHClient.xcframework .
          
          echo "âœ… ECHClient.xcframework æ„å»ºå®Œæˆ"
          ls -la ../ECHClient.xcframework/
          
          # éªŒè¯frameworkæ¶æ„å¹¶ç§»é™¤æ¨¡æ‹Ÿå™¨æ¶æ„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "../ECHClient.xcframework/ios-arm64/ECHClient.framework" ]; then
            echo "æ£€æŸ¥ arm64 çœŸæœº framework..."
            FRAMEWORK_BINARY="../ECHClient.xcframework/ios-arm64/ECHClient.framework/ECHClient"
            if [ -f "$FRAMEWORK_BINARY" ]; then
              echo "åŸå§‹æ¶æ„ä¿¡æ¯:"
              lipo -info "$FRAMEWORK_BINARY"
              
              # æ£€æŸ¥æ˜¯å¦æ˜¯ fat binaryï¼ˆåŒ…å«å¤šä¸ªæ¶æ„ï¼‰
              ARCH_INFO=$(lipo -info "$FRAMEWORK_BINARY" 2>&1)
              if echo "$ARCH_INFO" | grep -q "Architectures in the fat file"; then
                echo "æ£€æµ‹åˆ° fat binary,æå–çº¯ arm64 æ¶æ„..."
                if echo "$ARCH_INFO" | grep -q "arm64"; then
                  lipo "$FRAMEWORK_BINARY" -thin arm64 -output "${FRAMEWORK_BINARY}.tmp"
                  if [ $? -eq 0 ] && [ -f "${FRAMEWORK_BINARY}.tmp" ]; then
                    mv "${FRAMEWORK_BINARY}.tmp" "$FRAMEWORK_BINARY"
                    echo "âœ… æå–åçš„æ¶æ„ä¿¡æ¯:"
                    lipo -info "$FRAMEWORK_BINARY"
                  else
                    echo "âš ï¸  lipo æå–å¤±è´¥,ä¿æŒåŸæ–‡ä»¶"
                    rm -f "${FRAMEWORK_BINARY}.tmp"
                  fi
                else
                  echo "âš ï¸  è­¦å‘Š: fat binary ä¸­ä¸åŒ…å« arm64 æ¶æ„"
                fi
              else
                echo "âœ… å·²ç»æ˜¯å•ä¸€æ¶æ„,æ— éœ€å¤„ç†"
              fi
              
              # æœ€ç»ˆéªŒè¯
              echo "æœ€ç»ˆæ¶æ„ä¿¡æ¯:"
              lipo -info "$FRAMEWORK_BINARY"
              file "$FRAMEWORK_BINARY"
            fi
          fi
          
          # ç§»é™¤æ¨¡æ‹Ÿå™¨æ¶æ„çš„frameworkï¼ˆçˆ±æ€åŠ©æ‰‹ä¸éœ€è¦ï¼‰
          if [ -d "../ECHClient.xcframework/ios-arm64_x86_64-simulator" ]; then
            echo "ç§»é™¤æ¨¡æ‹Ÿå™¨æ¶æ„..."
            rm -rf "../ECHClient.xcframework/ios-arm64_x86_64-simulator"
          fi
          
          echo "æœ€ç»ˆ xcframework ç»“æ„:"
          ls -la ../ECHClient.xcframework/
      
      - name: Setup project structure
        run: |
          cd swift-ios
          
          echo "å‡†å¤‡é¡¹ç›®æ–‡ä»¶..."
          chmod +x create_xcode_project.sh
          ./create_xcode_project.sh
          
          # ç”Ÿæˆå„ç§å°ºå¯¸çš„å›¾æ ‡ (ä½¿ç”¨ sips å‘½ä»¤)
          if [ -f Assets.xcassets/AppIcon.appiconset/Icon-1024.png ]; then
            echo "ç”Ÿæˆåº”ç”¨å›¾æ ‡..."
            cd Assets.xcassets/AppIcon.appiconset
            sips -z 120 120 Icon-1024.png --out Icon-60@2x.png
            sips -z 180 180 Icon-1024.png --out Icon-60@3x.png
            sips -z 76 76 Icon-1024.png --out Icon-76.png
            sips -z 152 152 Icon-1024.png --out Icon-76@2x.png
            sips -z 167 167 Icon-1024.png --out Icon-83.5@2x.png
            cd ../..
            echo "âœ… åº”ç”¨å›¾æ ‡ç”Ÿæˆå®Œæˆ"
          fi
          
          echo "âœ… é¡¹ç›®ç»“æ„åˆ›å»ºå®Œæˆ"
          ls -la
      
      - name: Prepare for unsigned build
        run: |
          echo "å‡†å¤‡æœªç­¾åæ„å»ºï¼ˆTrollStore å…¼å®¹ï¼‰..."
          # ä¸åˆ›å»ºç­¾åè¯ä¹¦ï¼Œç›´æ¥æ„å»ºæœªç­¾åç‰ˆæœ¬
      
      - name: Build with xcodebuild
        run: |
          cd swift-ios
          
          echo "é¡¹ç›®ç»“æ„:"
          ls -la
          echo "ECHWorkers ç›®å½•:"
          ls -la ECHWorkers/ || true
          
          echo "ä½¿ç”¨ xcodebuild æ„å»ºï¼ˆæœªç­¾åç‰ˆæœ¬ï¼ŒTrollStore å…¼å®¹ï¼‰..."
          
          # å®Œå…¨ä¸ç­¾åæ„å»ºï¼ˆTrollStore éœ€è¦ï¼‰
          xcodebuild \
            -project ECHWorkers.xcodeproj \
            -scheme ECHWorkers \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            ONLY_ACTIVE_ARCH=NO \
            ARCHS=arm64 \
            IPHONEOS_DEPLOYMENT_TARGET=14.0 \
            2>&1 | tee build.log || (cat build.log && exit 1)
          
          echo "âœ… æ„å»ºå®Œæˆ"
          
          # æŸ¥æ‰¾ç”Ÿæˆçš„.app
          APP_PATH=$(find ./build -name "*.app" -type d | head -n 1)
          echo "æ‰¾åˆ°åº”ç”¨: $APP_PATH"
          
          # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
          if [ -n "$APP_PATH" ]; then
            if [ ! -f "$APP_PATH/ECHWorkers" ]; then
              echo "âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆä¸èƒ½ä¸ºç©ºï¼‰
            FILE_SIZE=$(stat -f%z "$APP_PATH/ECHWorkers" 2>/dev/null || stat -c%s "$APP_PATH/ECHWorkers" 2>/dev/null || echo "0")
            if [ "$FILE_SIZE" -eq 0 ]; then
              echo "âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶ä¸ºç©º"
              exit 1
            fi
            echo "å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            
            # æ£€æŸ¥æ–‡ä»¶ç±»å‹
            echo "æ–‡ä»¶ç±»å‹:"
            file "$APP_PATH/ECHWorkers"
            
            # æ£€æŸ¥æ¶æ„
            echo "æ¶æ„ä¿¡æ¯:"
            lipo -info "$APP_PATH/ECHWorkers" || (echo "âŒ lipo æ£€æŸ¥å¤±è´¥" && exit 1)
            
            # éªŒè¯æ¶æ„æ˜¯ arm64
            APP_ARCH=$(lipo -info "$APP_PATH/ECHWorkers" 2>&1)
            if ! echo "$APP_ARCH" | grep -q "arm64"; then
              echo "âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶æ¶æ„ä¸æ˜¯ arm64: $APP_ARCH"
              exit 1
            fi
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶æ¶æ„éªŒè¯é€šè¿‡: $APP_ARCH"
            
            # æ£€æŸ¥å½“å‰ç­¾åï¼ˆåº”è¯¥æ²¡æœ‰ç­¾åï¼‰
            echo "å½“å‰ç­¾åçŠ¶æ€:"
            codesign -dv "$APP_PATH/ECHWorkers" 2>&1 || echo "æœªç­¾åï¼ˆç¬¦åˆé¢„æœŸï¼‰"
            
            # ç¡®ä¿æ²¡æœ‰ç­¾åå’Œç­¾åç›®å½•ï¼ˆTrollStore éœ€è¦å®Œå…¨æœªç­¾åçš„åº”ç”¨ï¼‰
            echo "æ¸…ç†ä»»ä½•æ®‹ç•™çš„ç­¾å..."
            codesign --remove-signature "$APP_PATH/ECHWorkers" 2>/dev/null || true
            codesign --remove-signature "$APP_PATH" 2>/dev/null || true
            rm -rf "$APP_PATH/_CodeSignature" 2>/dev/null || true
            rm -rf "$APP_PATH/embedded.mobileprovision" 2>/dev/null || true
            
            # å†æ¬¡éªŒè¯æ–‡ä»¶ç±»å‹ï¼ˆç¡®ä¿ç§»é™¤ç­¾ååä»ç„¶æœ‰æ•ˆï¼‰
            echo "ç§»é™¤ç­¾ååçš„æ–‡ä»¶ç±»å‹:"
            file "$APP_PATH/ECHWorkers"
            
            # éªŒè¯ Mach-O æ ¼å¼
            echo "éªŒè¯ Mach-O æ ¼å¼..."
            if ! file "$APP_PATH/ECHWorkers" | grep -q "Mach-O"; then
              echo "âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ Mach-O æ ¼å¼"
              exit 1
            fi
            
            # ç¡®ä¿å¯æ‰§è¡Œæƒé™
            chmod +x "$APP_PATH/ECHWorkers"
            
            # ä½¿ç”¨ otool éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
            echo "ä½¿ç”¨ otool éªŒè¯:"
            otool -h "$APP_PATH/ECHWorkers" || (echo "âŒ otool éªŒè¯å¤±è´¥" && exit 1)
            
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶éªŒè¯é€šè¿‡"
          fi
          
          # å¤åˆ¶ ECHClient.xcframework åˆ° .app/Frameworks
          if [ -d ECHClient.xcframework ] && [ -n "$APP_PATH" ]; then
            echo "å¤åˆ¶ ECHClient.xcframework..."
            mkdir -p "$APP_PATH/Frameworks"
            # æ‰¾åˆ° ios-arm64 çš„ framework
            if [ -d "ECHClient.xcframework/ios-arm64/ECHClient.framework" ]; then
              # å…ˆæ¸…ç†ç›®æ ‡ç›®å½•
              rm -rf "$APP_PATH/Frameworks/ECHClient.framework" 2>/dev/null || true
              
              # å¤åˆ¶ framework - åªå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸å¤åˆ¶æ•´ä¸ªç›®å½•
              mkdir -p "$APP_PATH/Frameworks/ECHClient.framework"
              
              # åªå¤åˆ¶ Mach-O äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆè¿™æ˜¯å”¯ä¸€éœ€è¦çš„æ–‡ä»¶ï¼‰
              cp "ECHClient.xcframework/ios-arm64/ECHClient.framework/ECHClient" "$APP_PATH/Frameworks/ECHClient.framework/"
              
              echo "è®¾ç½® framework æƒé™å’Œç»“æ„..."
              
              # ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ­£ç¡®çš„æƒé™
              chmod 755 "$APP_PATH/Frameworks/ECHClient.framework/ECHClient"
              chmod 755 "$APP_PATH/Frameworks/ECHClient.framework"
              
              # åˆ›å»ºæœ€å°çš„ Info.plistï¼ˆiOS éœ€è¦å®ƒæ¥è¯†åˆ« frameworkï¼‰
              printf '<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n<key>CFBundleExecutable</key>\n<string>ECHClient</string>\n<key>CFBundleIdentifier</key>\n<string>com.echworkers.echclient</string>\n<key>CFBundleInfoDictionaryVersion</key>\n<string>6.0</string>\n<key>CFBundlePackageType</key>\n<string>FMWK</string>\n<key>CFBundleVersion</key>\n<string>1</string>\n<key>MinimumOSVersion</key>\n<string>14.0</string>\n</dict>\n</plist>\n' > "$APP_PATH/Frameworks/ECHClient.framework/Info.plist"
              
              # éªŒè¯æ¸…ç†å Framework åªåŒ…å«å¿…è¦æ–‡ä»¶
              echo "æ¸…ç†åçš„ Framework ç»“æ„:"
              ls -la "$APP_PATH/Frameworks/ECHClient.framework/"
              
              # éªŒè¯ framework å¯æ‰§è¡Œæ–‡ä»¶
              if [ -f "$APP_PATH/Frameworks/ECHClient.framework/ECHClient" ]; then
                echo "éªŒè¯ framework å¯æ‰§è¡Œæ–‡ä»¶..."
                file "$APP_PATH/Frameworks/ECHClient.framework/ECHClient"
                
                # éªŒè¯æ˜¯æœ‰æ•ˆçš„ Mach-O æ–‡ä»¶
                if ! file "$APP_PATH/Frameworks/ECHClient.framework/ECHClient" | grep -q "Mach-O"; then
                  echo "âŒ Framework å¯æ‰§è¡Œæ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ Mach-O æ ¼å¼"
                  exit 1
                fi
                
                # æ£€æŸ¥æ¶æ„
                echo "Framework æ¶æ„ä¿¡æ¯:"
                lipo -info "$APP_PATH/Frameworks/ECHClient.framework/ECHClient" || (echo "âŒ Framework æ¶æ„æ£€æŸ¥å¤±è´¥" && exit 1)
                
                # éªŒè¯æ¶æ„æ˜¯ arm64
                FRAMEWORK_ARCH=$(lipo -info "$APP_PATH/Frameworks/ECHClient.framework/ECHClient" 2>&1)
                if ! echo "$FRAMEWORK_ARCH" | grep -q "arm64"; then
                  echo "âš ï¸  è­¦å‘Š: Framework æ¶æ„ä¸æ˜¯ arm64: $FRAMEWORK_ARCH"
                fi
                
                otool -h "$APP_PATH/Frameworks/ECHClient.framework/ECHClient" || (echo "âŒ Framework éªŒè¯å¤±è´¥" && exit 1)
                
                # ç¡®ä¿ framework å¯æ‰§è¡Œæ–‡ä»¶æœ‰æ­£ç¡®çš„æƒé™
                chmod 755 "$APP_PATH/Frameworks/ECHClient.framework/ECHClient"
                
                # éªŒè¯ framework ç›®å½•ç»“æ„
                if [ ! -f "$APP_PATH/Frameworks/ECHClient.framework/Info.plist" ]; then
                  echo "âš ï¸  è­¦å‘Š: Framework Info.plist ä¸å­˜åœ¨ï¼Œåˆ›å»ºæœ€å°ç‰ˆæœ¬..."
                  printf '<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n    <key>CFBundleExecutable</key>\n    <string>ECHClient</string>\n    <key>CFBundleIdentifier</key>\n    <string>com.echworkers.echclient</string>\n    <key>CFBundleInfoDictionaryVersion</key>\n    <string>6.0</string>\n    <key>CFBundlePackageType</key>\n    <string>FMWK</string>\n    <key>CFBundleShortVersionString</key>\n    <string>1.0</string>\n    <key>CFBundleVersion</key>\n    <string>1</string>\n</dict>\n</plist>\n' > "$APP_PATH/Frameworks/ECHClient.framework/Info.plist"
                fi
              else
                echo "âŒ Framework å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
              fi
              
              echo "âœ… ECHClient.framework å·²å¤åˆ¶å¹¶éªŒè¯"
              
              # æœ€ç»ˆéªŒè¯ framework ç›®å½•ç»“æ„
              echo "éªŒè¯ framework æœ€ç»ˆç»“æ„..."
              if [ ! -d "$APP_PATH/Frameworks/ECHClient.framework" ]; then
                echo "âŒ Framework ç›®å½•ä¸å­˜åœ¨"
                exit 1
              fi
              
              # åˆ—å‡º framework ä¸­çš„æ‰€æœ‰æ–‡ä»¶
              echo "Framework æ–‡ä»¶åˆ—è¡¨:"
              find "$APP_PATH/Frameworks/ECHClient.framework" -type f | sort
              
              # ç¡®ä¿ framework ç›®å½•æœ‰æ­£ç¡®çš„æƒé™
              chmod 755 "$APP_PATH/Frameworks/ECHClient.framework"
              
              # éªŒè¯ framework ä¸­åªæœ‰å¿…è¦çš„æ–‡ä»¶
              FRAMEWORK_FILES=$(find "$APP_PATH/Frameworks/ECHClient.framework" -type f | wc -l)
              echo "Framework æ–‡ä»¶æ•°é‡: $FRAMEWORK_FILES"
              
              # ç¡®ä¿æ²¡æœ‰æ„å¤–çš„æ–‡ä»¶ç±»å‹
              find "$APP_PATH/Frameworks/ECHClient.framework" -type f | while read f; do
                FILE_TYPE=$(file "$f" | cut -d: -f2)
                if echo "$FILE_TYPE" | grep -q "Mach-O\|XML\|ASCII\|text\|empty"; then
                  echo "âœ… æœ‰æ•ˆæ–‡ä»¶: $f ($FILE_TYPE)"
                else
                  echo "âš ï¸  è­¦å‘Š: æ„å¤–çš„æ–‡ä»¶ç±»å‹: $f ($FILE_TYPE)"
                fi
              done
            fi
          fi
          
          # æŸ¥æ‰¾å¹¶éªŒè¯ app bundle ä¸­çš„æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
          echo "æŸ¥æ‰¾ app bundle ä¸­çš„æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶..."
          find "$APP_PATH" -type f -perm +111 -exec file {} \; | grep -i "mach-o" || true
          
          # ç¡®ä¿æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½æ˜¯æœ‰æ•ˆçš„ Mach-O æ ¼å¼
          echo "éªŒè¯æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶..."
          find "$APP_PATH" -type f -perm +111 | while read binary; do
            if file "$binary" | grep -q "Mach-O"; then
              echo "éªŒè¯: $binary"
              otool -h "$binary" > /dev/null 2>&1 || echo "âš ï¸  è­¦å‘Š: $binary éªŒè¯å¤±è´¥"
            fi
          done
          
          # å¤åˆ¶.appåˆ°å½“å‰ç›®å½•
          if [ -n "$APP_PATH" ]; then
            # ä½¿ç”¨ rsync æˆ– cp ç¡®ä¿å®Œæ•´å¤åˆ¶
            cp -R "$APP_PATH" ./ECHWorkers.app
            
            # éªŒè¯å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶
            if [ -f "./ECHWorkers.app/ECHWorkers" ]; then
              echo "éªŒè¯å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶..."
              file "./ECHWorkers.app/ECHWorkers"
              otool -h "./ECHWorkers.app/ECHWorkers" || (echo "âŒ å¤åˆ¶åéªŒè¯å¤±è´¥" && exit 1)
              
              # ç¡®ä¿å¯æ‰§è¡Œæƒé™
              chmod +x "./ECHWorkers.app/ECHWorkers"
              
              # éªŒè¯æ‰€æœ‰ framework äºŒè¿›åˆ¶æ–‡ä»¶
              if [ -d "./ECHWorkers.app/Frameworks" ]; then
                find "./ECHWorkers.app/Frameworks" -type f -perm +111 | while read binary; do
                  if file "$binary" | grep -q "Mach-O"; then
                    echo "éªŒè¯ framework äºŒè¿›åˆ¶: $binary"
                    otool -h "$binary" > /dev/null 2>&1 || echo "âš ï¸  è­¦å‘Š: $binary éªŒè¯å¤±è´¥"
                    chmod +x "$binary"
                  fi
                done
              fi
              
              echo "âœ… å¤åˆ¶åéªŒè¯é€šè¿‡"
            fi
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆ app å¤§å°
          echo "App å†…å®¹:"
          ls -la ./ECHWorkers.app/
          echo "App æ€»å¤§å°:"
          du -sh ./ECHWorkers.app/
      
      - name: Package IPA
        run: |
          cd swift-ios
          
          # æœ€ç»ˆéªŒè¯å¯æ‰§è¡Œæ–‡ä»¶å’Œ app bundle ç»“æ„
          if [ -f "./ECHWorkers.app/ECHWorkers" ]; then
            echo "æœ€ç»ˆéªŒè¯å¯æ‰§è¡Œæ–‡ä»¶..."
            file "./ECHWorkers.app/ECHWorkers"
            otool -h "./ECHWorkers.app/ECHWorkers" || (echo "âŒ æœ€ç»ˆéªŒè¯å¤±è´¥" && exit 1)
            
            # éªŒè¯ Info.plist å­˜åœ¨ä¸”æ­£ç¡®
            if [ ! -f "./ECHWorkers.app/Info.plist" ]; then
              echo "âŒ é”™è¯¯: Info.plist ä¸å­˜åœ¨"
              exit 1
            fi
            
            # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶åä¸ Info.plist ä¸­çš„ä¸€è‡´
            EXECUTABLE_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "./ECHWorkers.app/Info.plist" 2>/dev/null || echo "")
            if [ "$EXECUTABLE_NAME" != "ECHWorkers" ]; then
              echo "âš ï¸  è­¦å‘Š: Info.plist ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶å ($EXECUTABLE_NAME) ä¸æ–‡ä»¶åä¸åŒ¹é…"
            fi
            
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶å’Œ app bundle éªŒè¯é€šè¿‡"
          else
            echo "âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # åˆ›å»º Payload ç›®å½•
          mkdir -p Payload
          
          # ä½¿ç”¨ cp -R ç¡®ä¿å®Œæ•´å¤åˆ¶
          cp -R ECHWorkers.app Payload/
          
          # ç¡®ä¿ .app bundle æœ¬èº«æ˜¯ä¸€ä¸ªç›®å½•ï¼ˆä¸æ˜¯æ–‡ä»¶æˆ–ç¬¦å·é“¾æ¥ï¼‰
          if [ ! -d "Payload/ECHWorkers.app" ]; then
            echo "âŒ é”™è¯¯: .app bundle ä¸æ˜¯ç›®å½•"
            exit 1
          fi
          
          # ç¡®ä¿ .app bundle æœ‰æ­£ç¡®çš„æƒé™
          chmod 755 "Payload/ECHWorkers.app"
          
          # å½»åº•æ¸…ç†å¯èƒ½å¯¼è‡´ ldid æ··æ·†çš„æ‰€æœ‰æ–‡ä»¶
          echo "å½»åº•æ¸…ç† .app bundle..."
          find "Payload/ECHWorkers.app" -name ".DS_Store" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "._*" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name ".git*" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -type l -delete 2>/dev/null || true
          
          # ç§»é™¤æ‰€æœ‰ç­¾åç›¸å…³æ–‡ä»¶
          find "Payload/ECHWorkers.app" -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "embedded.mobileprovision" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "*.entitlements" -delete 2>/dev/null || true
          
          # ç¡®ä¿æ‰€æœ‰ç›®å½•éƒ½æœ‰æ­£ç¡®çš„æƒé™
          find "Payload/ECHWorkers.app" -type d -exec chmod 755 {} \; 2>/dev/null || true
          
          # ç¡®ä¿æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½æœ‰æ­£ç¡®çš„æƒé™
          find "Payload/ECHWorkers.app" -type f -perm +111 -exec chmod 755 {} \; 2>/dev/null || true
          
          # ç¡®ä¿æ‰€æœ‰æ™®é€šæ–‡ä»¶éƒ½æœ‰æ­£ç¡®çš„æƒé™
          find "Payload/ECHWorkers.app" -type f ! -perm +111 -exec chmod 644 {} \; 2>/dev/null || true
          
          # æœ€ç»ˆéªŒè¯æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„æ¶æ„
          echo "æœ€ç»ˆéªŒè¯æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„æ¶æ„..."
          find "Payload/ECHWorkers.app" -type f -perm +111 | while read binary; do
            if file "$binary" | grep -q "Mach-O"; then
              echo "éªŒè¯æ¶æ„: $binary"
              ARCH_INFO=$(lipo -info "$binary" 2>&1)
              if [ $? -eq 0 ]; then
                echo "  âœ… $ARCH_INFO"
                if ! echo "$ARCH_INFO" | grep -q "arm64"; then
                  echo "  âš ï¸  è­¦å‘Š: ä¸æ˜¯ arm64 æ¶æ„"
                fi
              else
                echo "  âŒ æ¶æ„æ£€æŸ¥å¤±è´¥: $ARCH_INFO"
              fi
            fi
          done
          
          # æ¸…ç†å¯èƒ½å¯¼è‡´é—®é¢˜çš„æ–‡ä»¶å’Œç›®å½•
          echo "æ¸…ç†å¯èƒ½å¯¼è‡´é—®é¢˜çš„æ–‡ä»¶..."
          find "Payload/ECHWorkers.app" -name ".DS_Store" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "*.swiftmodule" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "*.swiftdoc" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "*.swiftsourceinfo" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -type l -delete 2>/dev/null || true
          
          # ç§»é™¤æ‰€æœ‰ç­¾åç›¸å…³æ–‡ä»¶
          find "Payload/ECHWorkers.app" -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "embedded.mobileprovision" -delete 2>/dev/null || true
          find "Payload/ECHWorkers.app" -name "*.entitlements" -delete 2>/dev/null || true
          
          # å†æ¬¡éªŒè¯ Payload ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "Payload/ECHWorkers.app/ECHWorkers" ]; then
            echo "éªŒè¯ Payload ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶..."
            file "Payload/ECHWorkers.app/ECHWorkers"
            otool -h "Payload/ECHWorkers.app/ECHWorkers" || (echo "âŒ Payload éªŒè¯å¤±è´¥" && exit 1)
            
            # ç¡®ä¿å¯æ‰§è¡Œæ–‡ä»¶æœ‰æ­£ç¡®çš„æƒé™
            chmod 755 "Payload/ECHWorkers.app/ECHWorkers"
            
            # æ˜¾ç¤º app bundle ç»“æ„
            echo "App bundle ç»“æ„:"
            find "Payload/ECHWorkers.app" -type f | head -20
            
            # ç¡®ä¿æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½æ˜¯æœ‰æ•ˆçš„ Mach-O æ ¼å¼
            echo "æœ€ç»ˆæ£€æŸ¥æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶..."
            find "Payload/ECHWorkers.app" -type f -perm +111 | while read binary; do
              if file "$binary" | grep -q "Mach-O"; then
                echo "âœ… æœ‰æ•ˆäºŒè¿›åˆ¶: $binary"
                # ç¡®ä¿æ–‡ä»¶æœ‰æ­£ç¡®çš„æƒé™
                chmod 755 "$binary"
              else
                echo "âš ï¸  é Mach-O æ–‡ä»¶ä½†æœ‰æ‰§è¡Œæƒé™: $binary"
                # ç§»é™¤æ‰§è¡Œæƒé™ï¼ˆå¦‚æœä¸æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
                chmod 644 "$binary" 2>/dev/null || true
              fi
            done
            
            # éªŒè¯ framework äºŒè¿›åˆ¶æ–‡ä»¶
            if [ -d "Payload/ECHWorkers.app/Frameworks" ]; then
              echo "éªŒè¯ Frameworks ä¸­çš„äºŒè¿›åˆ¶æ–‡ä»¶..."
              find "Payload/ECHWorkers.app/Frameworks" -type f -perm +111 | while read binary; do
                if file "$binary" | grep -q "Mach-O"; then
                  echo "âœ… Framework äºŒè¿›åˆ¶: $binary"
                  chmod 755 "$binary"
                  otool -h "$binary" > /dev/null 2>&1 || echo "âš ï¸  è­¦å‘Š: $binary éªŒè¯å¤±è´¥"
                fi
              done
            fi
            
            # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ç±»å‹
            echo "App bundle ä¸­çš„æ–‡ä»¶ç±»å‹ç»Ÿè®¡:"
            find "Payload/ECHWorkers.app" -type f -exec file {} \; | sort | uniq -c
            
            # éªŒè¯ .app bundle æ˜¯ä¸€ä¸ªç›®å½•ï¼ˆä¸æ˜¯æ–‡ä»¶ï¼‰
            if [ ! -d "Payload/ECHWorkers.app" ]; then
              echo "âŒ é”™è¯¯: .app bundle ä¸æ˜¯ç›®å½•"
              exit 1
            fi
            
            # ç¡®ä¿ Info.plist å­˜åœ¨
            if [ ! -f "Payload/ECHWorkers.app/Info.plist" ]; then
              echo "âŒ é”™è¯¯: Info.plist ä¸å­˜åœ¨"
              exit 1
            fi
            
            # ã€å…³é”®ã€‘å¼ºåˆ¶æ‰€æœ‰ Mach-O äºŒè¿›åˆ¶æ–‡ä»¶åªåŒ…å« arm64 æ¶æ„
            echo "ğŸ”§ å¼ºåˆ¶æå–æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„ arm64 æ¶æ„ï¼ˆç§»é™¤ fat binaryï¼‰..."
            find "Payload/ECHWorkers.app" -type f | while read file; do
              if file "$file" | grep -q "Mach-O"; then
                echo "å¤„ç†: $file"
                ARCH_INFO=$(lipo -info "$file" 2>&1)
                echo "  å½“å‰æ¶æ„: $ARCH_INFO"
                
                # åªå¯¹ fat binary æ‰§è¡Œ lipo -thin
                if echo "$ARCH_INFO" | grep -q "Architectures in the fat file"; then
                  echo "  æ£€æµ‹åˆ° fat binary,æå– arm64..."
                  if echo "$ARCH_INFO" | grep -q "arm64"; then
                    lipo "$file" -thin arm64 -output "${file}.tmp" 2>/dev/null
                    if [ $? -eq 0 ] && [ -f "${file}.tmp" ]; then
                      mv "${file}.tmp" "$file"
                      NEW_ARCH=$(lipo -info "$file" 2>&1)
                      echo "  âœ… æå–åæ¶æ„: $NEW_ARCH"
                    else
                      echo "  âš ï¸  lipo æå–å¤±è´¥,ä¿æŒåŸæ–‡ä»¶"
                      rm -f "${file}.tmp"
                    fi
                  else
                    echo "  âš ï¸  è­¦å‘Š: fat binary ä¸åŒ…å« arm64 æ¶æ„"
                  fi
                elif echo "$ARCH_INFO" | grep -q "Non-fat file.*arm64"; then
                  echo "  âœ… å·²æ˜¯çº¯ arm64 æ¶æ„,æ— éœ€å¤„ç†"
                else
                  echo "  â„¹ï¸  å•ä¸€æ¶æ„æ–‡ä»¶: $ARCH_INFO"
                fi
              fi
            done
            
            # æœ€ç»ˆéªŒè¯æ‰€æœ‰äºŒè¿›åˆ¶éƒ½æ˜¯çº¯ arm64ï¼ˆé fat binaryï¼‰
            echo "ğŸ” æœ€ç»ˆéªŒè¯æ‰€æœ‰äºŒè¿›åˆ¶æ¶æ„..."
            HAS_NON_ARM64=0
            find "Payload/ECHWorkers.app" -type f | while read file; do
              if file "$file" | grep -q "Mach-O"; then
                ARCH_INFO=$(lipo -info "$file" 2>&1)
                if ! echo "$ARCH_INFO" | grep -q "^Non-fat file.*arm64$"; then
                  if ! echo "$ARCH_INFO" | grep -q "^Architectures in the fat file.*arm64$" || echo "$ARCH_INFO" | grep -q "x86_64\|i386"; then
                    echo "âš ï¸  $file: $ARCH_INFO"
                    HAS_NON_ARM64=1
                  fi
                fi
                echo "  âœ… $file: arm64 only"
              fi
            done
          fi
          
          # è·å– commit hash
          COMMIT_HASH="${{ steps.commit.outputs.commit_hash }}"
          IPA_NAME="${COMMIT_HASH}-ECHWorkers-Swift-unsigned.ipa"
          
          # æ‰“åŒ…ä¸º IPAï¼ˆä½¿ç”¨å­˜å‚¨æ¨¡å¼ï¼Œé¿å…å‹ç¼©æŸåäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
          zip -0 -r "../${IPA_NAME}" Payload
          
          cd ..
          echo "âœ… IPAæ‰“åŒ…å®Œæˆ: ${IPA_NAME}"
          ls -lh "${IPA_NAME}"
          
          # å°† IPA æ–‡ä»¶åä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "IPA_NAME=${IPA_NAME}" >> $GITHUB_ENV
      
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges | head -n 20)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- SwiftåŸç”ŸiOSç‰ˆæœ¬é¦–æ¬¡å‘å¸ƒ"
          fi
          
          echo "$CHANGELOG" > CHANGELOG.txt
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ECHWorkers-Swift-iOS
          path: "${{ env.IPA_NAME }}"
      
      - name: Generate release tag
        id: tag
        run: |
          TAG="ios-swift-v1.2.0-$(date +'%Y%m%d-%H%M%S')"
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: "iOS Swiftç‰ˆæœ¬ ${{ steps.tag.outputs.release_tag }}"
          body: |
            # ECH Workers - SwiftåŸç”ŸiOSç‰ˆæœ¬
            
            **âœ… å®Œæ•´ECHåŠŸèƒ½ + åŸç”ŸSwiftç•Œé¢**
            
            ## ç‰¹æ€§
            
            - âœ… åŸç”ŸSwiftUIç•Œé¢
            - âœ… å®Œæ•´ECHåŠ å¯†æ”¯æŒ (Go 1.23)
            - âœ… WebSocketéš§é“
            - âœ… SOCKS5ä»£ç†
            - âœ… TrollStoreå®Œç¾æ”¯æŒ
            
            ## å®‰è£…æ–¹æ³•
            
            ### TrollStoreå®‰è£…ï¼ˆæ¨èï¼‰
            1. ä¸‹è½½ `${{ env.IPA_NAME }}`
            2. åœ¨TrollStoreä¸­å®‰è£…
            3. æ‰“å¼€åº”ç”¨å³å¯ä½¿ç”¨
            
            **Commit**: ${{ steps.commit.outputs.commit_hash }}
            
            ### å…¶ä»–ç­¾åå·¥å…·
            - AltStore
            - Sideloadly
            - çˆ±æ€åŠ©æ‰‹
            
            ## ä½¿ç”¨è¯´æ˜
            
            1. æ‰“å¼€åº”ç”¨
            2. å¡«å†™æœåŠ¡å™¨åœ°å€
            3. ç‚¹å‡»"å¯åŠ¨ä»£ç†"
            4. åœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½®SOCKS5ä»£ç†ï¼š127.0.0.1:30000
            
            ## æ›´æ–°æ—¥å¿—
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            
            **ç‰ˆæœ¬**: 1.2.0-Swift
            **æœ€ä½iOSç‰ˆæœ¬**: 14.0
            **æ¶æ„**: arm64
            **Commit**: ${{ steps.commit.outputs.commit_hash }}
          files: |
            ${{ env.IPA_NAME }}
            CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
